# Futarchy Aggregator Subgraph (Gnosis)

This subgraph indexes the Futarchy Aggregator, Organization, and Proposal contracts on Gnosis Chain.

## ðŸ”— Architecture & Mapping Logic

The subgraph uses a **Dynamic Template System** to index the hierarchical structure of the Futarchy contracts. It starts from a single "root" contract and dynamically spawns listeners for child contracts.

### 1. The Root: Creator Contract
- **Address**: `0x511D18d5567d76bbd20dEaDF4F90CD9f039eEd2D`
- **Role**: This is the top-level factory.
- **Event Tracked**: `AggregatorMetadataCreated`
- **Action**: When this event fires, the subgraph:
    - Creates a new `Aggregator` entity.
    - **Spawns a new listener** (Template) for the specific Aggregator address using `AggregatorTemplate`.

### 2. Level 1: Aggregator Contract
- **Role**: Manages a group of Organizations (e.g., "FutarchyFi").
- **Dynamic Source**: Generated by the Creator.
- **Event Tracked**: `OrganizationAdded`
- **Action**: When an Organization is added, the subgraph:
    - Creates a new `Organization` entity.
    - Links it to the parent Aggregator.
    - **Spawns a new listener** for the Organization address using `OrganizationTemplate`.

### 3. Level 2: Organization Contract
- **Role**: Represents a DAO or Company (e.g., "Gnosis DAO").
- **Dynamic Source**: Generated by the Aggregator.
- **Event Tracked**: `ProposalAdded`
- **Action**: When a Proposal is added, the subgraph:
    - Creates a new `Proposal` entity.
    - Links it to the parent Organization.
    - Fetches metadata (Question, Event Name, Description) from the Proposal contract.

### Summary Flow
`Creator` (0x511...) -> spawns `Aggregator` Listener -> spawns `Organization` Listener -> detects `Proposal` (Data)

## Directory Structure

- `schema.graphql`: Defines the GraphQL entities.
- `subgraph.yaml`: Subgraph configuration (data sources, mappings).
- `src/mapping.ts`: AssemblyScript logic for event handling.
- `abis/`: Contract ABI files.

## Prerequisites

- Node.js and npm/yarn
- The Graph CLI (`npm install -g @graphprotocol/graph-cli` or use local)

## Setup

1. Install dependencies:
   ```bash
   npm install
   ```

## Build and Deploy

1. **Codegen**: Generate TypeScript types from schema and ABIs.
   ```bash
   npm run codegen
   ```

2. **Build**: Compile the subgraph.
   ```bash
   npm run build
   ```

3. **Authenticate**: (If not already done)
   ```bash
   graph auth --studio <DEPLOY_KEY>
   ```

4. **Deploy**:
   ```bash
   npm run deploy
   ```

## Configuration

- **Network**: Gnosis
- **Start Block**: 43,517,000 (Optimized to catch recent deployments)
- **Creator Address**: `0x511D18d5567d76bbd20dEaDF4F90CD9f039eEd2D`
