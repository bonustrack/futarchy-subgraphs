<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futarchy COMPLETE Explorer</title>
    <script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background: #0f172a;
            color: #fff;
            padding: 20px;
        }

        .card {
            background: #1e293b;
            padding: 20px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #334155;
        }

        .card:hover {
            border-color: #38bdf8;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .tag {
            background: #334155;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-right: 5px;
        }

        .pool-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            border-radius: 4px;
        }

        .pool-row:hover {
            background: #334155;
        }

        h1 {
            color: #38bdf8;
        }

        .active {
            color: #4ade80;
        }

        .section-title {
            margin-top: 30px;
            border-top: 1px solid #333;
            padding-top: 20px;
        }
    </style>
</head>

<body>

    <h1>Unified Futarchy Explorer (v0.0.4 w/ Candles Only)</h1>
    <p>NavPath: <span id="nav-path">Home</span></p>
    <button onclick="loadAggregators()">Home (Aggregators)</button>

    <div id="content" class="grid"></div>

    <script>
        const API_URL = "https://api.studio.thegraph.com/query/1718249/futarchy-complete/v0.0.21";
        const API_URL_CANDLES = "https://api.studio.thegraph.com/query/1718249/algebra-candles/v0.0.4";

        let currentChart = null;

        async function gql(query, url = API_URL) {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
            const json = await res.json();
            if (json.errors) {
                console.error("GQL Error:", json.errors);
                if (url === API_URL_CANDLES) return { data: {} };

                document.getElementById('content').innerText = "Error: " + JSON.stringify(json.errors);
                throw new Error(json.errors[0].message);
            }
            return json.data;
        }

        async function loadAggregators() {
            document.getElementById('nav-path').innerText = "Agents";
            const data = await gql(`{ aggregators { id, name, description, organizations { id } } }`);
            const html = data.aggregators.map(a => `
                <div class="card" onclick="loadOrgs('${a.id}', '${a.name}')">
                    <h3>${a.name}</h3>
                    <p>${a.description}</p>
                    <span class="tag">${a.organizations.length} Organizations</span>
                </div>
            `).join('');
            document.getElementById('content').innerHTML = html;
        }

        async function loadOrgs(aggId, aggName) {
            document.getElementById('nav-path').innerText = `${aggName} > Organizations`;
            const data = await gql(`{ aggregator(id: "${aggId}") { organizations { id, name, description, proposals { id } } } }`);
            const html = data.aggregator.organizations.map(o => `
                <div class="card" onclick="loadProposals('${o.id}', '${o.name}')">
                    <h3>${o.name}</h3>
                    <p>${o.description}</p>
                    <span class="tag">${o.proposals.length} Proposals</span>
                </div>
            `).join('');
            document.getElementById('content').innerHTML = html;
        }

        async function loadProposals(orgId, orgName) {
            document.getElementById('nav-path').innerText = `${orgName} > Proposals`;
            const data = await gql(`{ organization(id: "${orgId}") { name, proposals { id, title, description, marketName, displayNameEvent, displayNameQuestion, 
                poolConditionalYes { id currentPrice } 
            } } }`);

            const html = data.organization.proposals.map(p => `
                <div class="card" onclick="loadDetail('${p.id}')">
                    <h3>${p.displayNameEvent || p.title}</h3>
                    <p style="color:#aaa">${p.displayNameQuestion}</p>
                    <hr style="border-color:#333"/>
                    <p style="font-size:0.8em; color:#888">Market: ${p.marketName}</p>
                    <p>Price: ${p.poolConditionalYes ? parseFloat(p.poolConditionalYes.currentPrice).toFixed(4) : 'N/A'}</p>
                </div>
            `).join('');
            document.getElementById('content').innerHTML = html;
        }

        async function loadDetail(id) {
            document.getElementById('nav-path').innerText = `Proposal ${id}`;
            // 1. Fetch all pools from Futarchy Complete
            const data = await gql(`
                { 
                    unifiedOneStopShop(id: "${id}") { 
                        title, description, marketName, displayNameEvent, displayNameQuestion,
                        companyToken { symbol decimals }
                        currencyToken { symbol decimals }
                        
                        outcomeYesCompany outcomeNoCompany outcomeYesCurrency outcomeNoCurrency

                        poolConditionalYes { id currentPrice volume24h }
                        poolConditionalNo { id currentPrice volume24h }
                        poolExpectedYes { id currentPrice volume24h }
                        poolExpectedNo { id currentPrice volume24h }
                        poolPredictionYes { id currentPrice volume24h }
                        poolPredictionNo { id currentPrice volume24h }
                    } 
                }
            `);
            const p = data.unifiedOneStopShop;

            const html = `
                <div style="grid-column: 1 / -1; background:#1e293b; padding:20px; border-radius:8px;">
                    <h2>${p.marketName || 'Market'}</h2>
                    <h3 style="color:#a78bfa">${p.displayNameEvent}</h3>
                    <p style="color:#ccc">${p.displayNameQuestion}</p>

                    <div style="background:#0f172a; padding:10px; margin-top:10px; border-radius:4px; font-family:monospace; font-size:0.8em;">
                        <strong>Outcomes:</strong><br>
                        YES: ${p.outcomeYesCompany ? p.outcomeYesCompany.slice(0, 10) + '...' : 'N/A'}<br>
                        NO: ${p.outcomeNoCompany ? p.outcomeNoCompany.slice(0, 10) + '...' : 'N/A'}
                    </div>
                    
                    <div style="margin-top:20px;">
                        <h4>Pools (Click to Load Chart)</h4>
                        ${renderPoolRow("Conditional YES", p.poolConditionalYes)}
                        ${renderPoolRow("Conditional NO", p.poolConditionalNo)}
                        ${renderPoolRow("Expected YES", p.poolExpectedYes)}
                        ${renderPoolRow("Expected NO", p.poolExpectedNo)}
                        ${renderPoolRow("Prediction YES", p.poolPredictionYes)}
                        ${renderPoolRow("Prediction NO", p.poolPredictionNo)}
                    </div>

                    <div id="deep-dive-section" class="section-title">
                        <h3 id="chart-title">Select a pool to view details</h3>
                        <div id="chart-container" style="height: 300px; width:100%; margin-bottom:20px;"></div>
                    </div>
                </div>
            `;
            document.getElementById('content').innerHTML = html;

            // Auto-load Conditional YES if it exists
            if (p.poolConditionalYes) {
                loadPoolDeepDive(p.poolConditionalYes.id, "Conditional YES");
            }
        }

        function renderPoolRow(name, pool) {
            if (!pool) return `<div class="pool-row" style="opacity:0.5; cursor:default;"><span>${name}</span> <span style="color:#d99">Not Found</span></div>`;
            return `
                <div class="pool-row" onclick="loadPoolDeepDive('${pool.id}', '${name}')">
                    <span>${name}</span> 
                    <span style="font-family:monospace; font-size:0.9em; color:#aaa;">${pool.id}</span>
                    <span>$${parseFloat(pool.currentPrice).toFixed(4)}</span>
                </div>`;
        }

        async function loadPoolDeepDive(poolId, poolName) {
            document.getElementById('chart-title').innerText = `${poolName} Deep Dive (${poolId})`;
            // document.getElementById('trades-container').innerHTML = "<p>Loading...</p>";
            document.getElementById('chart-container').innerHTML = ""; // Clear chart

            // Fetch Candles ONLY (Trades removed due to schema mismatch in v0.0.4)
            const res = await gql(`
                {
                    candles(where: { pool: "${poolId}" }, orderBy: periodStartUnix, orderDirection: asc, first: 1000) {
                        periodStartUnix open high low close
                    }
                }
            `, API_URL_CANDLES);

            if (!res || !res.candles) {
                document.getElementById('chart-container').innerHTML = "<p>No data found for this pool.</p>";
                return;
            }

            // Render Chart
            const candles = res.candles.map(c => ({
                time: parseInt(c.periodStartUnix),
                open: parseFloat(c.open),
                high: parseFloat(c.high),
                low: parseFloat(c.low),
                close: parseFloat(c.close)
            }));

            // Sort
            candles.sort((a, b) => a.time - b.time);

            // Dedupe
            const uniqueData = [];
            const times = new Set();
            for (let d of candles) {
                if (!times.has(d.time)) {
                    times.add(d.time);
                    uniqueData.push(d);
                }
            }

            renderChart('chart-container', uniqueData);
        }

        function renderChart(containerId, data) {
            if (currentChart) {
                // remove() method might not identify properly if we just clear HTML, but let's try to be clean
            }

            if (data.length === 0) {
                document.getElementById(containerId).innerText = "No candle data available.";
                return;
            }

            const container = document.getElementById(containerId);
            const chart = LightweightCharts.createChart(container, {
                layout: { background: { color: '#1e293b' }, textColor: '#DDD' },
                grid: { vertLines: { color: '#334155' }, horzLines: { color: '#334155' } },
                width: container.clientWidth,
                height: 300,
            });

            const candlestickSeries = chart.addCandlestickSeries({
                upColor: '#4ade80', downColor: '#f87171', borderVisible: false, wickUpColor: '#4ade80', wickDownColor: '#f87171',
            });

            candlestickSeries.setData(data);
            chart.timeScale().fitContent();
        }

        // Start
        loadAggregators();

    </script>
</body>

</html>